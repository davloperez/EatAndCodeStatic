<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Blog personal de David López, programador web en Xepient Solutions. Aquí podrás encontrar artículos relacionados con la programación web, herramientas y otras reflexiones.">
    

    <!--Author-->
    
        <meta name="author" content="David López Pérez">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Cómo hacer que Jenkins utilice una configuración de NPM específica"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="Blog personal de David López, programador web en Xepient Solutions. Aquí podrás encontrar artículos relacionados con la programación web, herramientas y otras reflexiones." />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Eat&amp;Code"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    
        <meta property="og:image" content="http://eatandcode.es/images/jenkins-npm.png" />
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Cómo hacer que Jenkins utilice una configuración de NPM específica - Eat&amp;Code</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.css" type="text/css" rel="stylesheet" />
	
	
		<link rel="amphtml" href="http://eatandcode.es/2016/08/20/configurar-jenkins-para-usar-sinopia/amp/index.html">
	

    <!-- Google Analytics -->
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-73435519-2', 'auto');
        ga('send', 'pageview');

    </script>



</head>

<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Eat&Code</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Inicio
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archivos
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://twitter.com/DavidCehegin">
                            
                                &nbsp;<i class="fa fa-twitter fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('http://eatandcode.es/images/blog-header.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Cómo hacer que Jenkins utilice una configuración de NPM específica</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        20-08-2016
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/Sinopia/">#Sinopia</a> <a href="/tags/npm/">#npm</a> <a href="/tags/repositorio/">#repositorio</a> <a href="/tags/Jenkins/">#Jenkins</a> <a href="/tags/test/">#test</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                        

<a href="/categories/Node-js/">Node.js</a>/ <a href="/categories/Node-js/Integracion-continua/">Integración continua</a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p><a href="https://jenkins.io/" title="Página web oficial de Jenkins" target="_blank" rel="external">Jenkins</a> es uno de los entornos de integración continua más conocidos, sobre todo en el entorno Java, pero que gracias a su sistema de plugins y a su versatilidad, también puede ser utilizado en proyectos de muchas otras tecnologías.</p>
<p>Una de las posibilidades que nos ofrece es la integración con Node.js, de manera que podemos ejecutar, por ejemplo, los test Mocha de nuestros proyectos, y obtener una visualización de los resultados e históricos (además de la querida funcionalidad del envío de emails cuando alguien hace cambios en el código que provoquen el fallo de algún test). Si queréis saber como configurar Jenkins para esto, podéis verlo en este <a href="https://blog.dylants.com/2013/06/21/jenkins-and-node/" title="CONTINUOUS INTEGRATION WITH JENKINS AND NODE.JS" target="_blank" rel="external">estupendo artículo</a></p>
<h2 id="El-problema-de-NPM-con-Jenkins-en-Windows"><a href="#El-problema-de-NPM-con-Jenkins-en-Windows" class="headerlink" title="El problema de NPM con Jenkins en Windows"></a>El problema de NPM con Jenkins en Windows</h2><p><strong>NOTA: desconozco si este problema también ocurre en Linux o Mac. Si alguno de vosotros quiere probarlo, puede poner los resultados en los comentarios.</strong></p>
<p>Si seguimos el artículo que he puesto en el párrafo anterior, no tendremos ningún problema para poner en marcha nuestro entorno de CI para la ejecución de nuestros test unitarios, <strong>excepto si utilizamos algún tipo de configuración especial de NPM</strong>. Cuando digo “configuración especial” me refiero a, por ejemplo, si haces uso de <a href="http://eatandcode.es/2016/06/07/Como-montar-tu-repositorio-npm-privado-con-sinopia/" title="Cómo montar tu repositorio NPM privado con Sinopia">Sinopia como repositorio NPM privado</a>, o si es necesaria la autenticación para la descarga de algún paquete NPM.</p>
<p>Esta configuración de autenticación, URL del registro, etc. habitualmente se almacena en el fichero <a href="https://docs.npmjs.com/files/npmrc" title="Especificación oficial del fichero .npmrc" target="_blank" rel="external">.npmrc</a> que reside en nuestra carpeta Home de usuario (en Windows suele estar en <em>C:\Users\David</em>)</p>
<p>Pero el problema está en que Jenkins no utiliza las mismas variables de entorno que disponemos en una consola CMD común, y por tanto, cuando ejecutamos algún comando NPM, éste no es capaz de acceder a la configuración de autenticación o de registro que tenemos en nuestro fichero .npmrc.</p>
<p>Este es un ejemplo del log que muestra Jenkins cuando tratamos de ejecutar el comando <code>npm install</code> desde un Job y en el <em>package.json</em> tenemos como dependencias algunos de nuestros módulos privados en Sinopia.</p>
<p><img src="/images/jenkins-npm-error-404.png" alt="Log del error al ejecutar npm install" title="Log del error al ejecutar npm install"><span class="image-caption">Log del error al ejecutar npm install</span></p>
<p>En la imagen anterior podemos ver cómo al hacer <code>npm install</code> NPM trata de obtener el paquete privado <strong>xs-wf-event-type-service</strong> del repositorio central de NPM, en vez de buscarlo en nuestro servidor Sinopia.</p>
<h2 id="La-solucion-esta-en-las-variables-de-entorno"><a href="#La-solucion-esta-en-las-variables-de-entorno" class="headerlink" title="La solución está en las variables de entorno"></a>La solución está en las variables de entorno</h2><p>Existen algunos <a href="https://wiki.jenkins-ci.org/display/JENKINS/NodeJS+Plugin" title="NodeJS Plugin" target="_blank" rel="external">plugins de Jenkins</a> que parece ser que nos dejan configurar diferentes instalaciones y configuraciones de Node.js y NPM. El inconveniente es que por el momento sólo está disponible para Linux. Si tu caso, como el mío, es que estás en un entorno Windows, podrás resolver este problema de la manera que explico a continuación.</p>
<p>La solución se basa en saber que NPM utiliza la variable de entorno <code>USERPROFILE</code> para determinar dónde buscar el fichero .npmrc. Y esa variable de entorno no está definida cuando ejecutamos un script CMD desde Jenkins. Por tanto, simplemente tenemos que definirla en la configuración de Jenkins y darle el valor adecuado para que localice nuestra carpeta Home.</p>
<p>Accedemos a esta sección desde Configurar Jenkins -&gt; Configurar el Sistema -&gt; Propiedades Globales</p>
<p><img src="/images/jenkins-environment-variables.png" alt="Configuración de las variables de entorno en Jenkins" title="Configuración de las variables de entorno en Jenkins"><span class="image-caption">Configuración de las variables de entorno en Jenkins</span></p>
<p>Guardamos, y ahora sí podremos ejecutar <code>npm install</code> desde nuestros Jobs con la certeza de que van a utilizar nuestra configuración personalizada que tengamos almacenada en el fichero .npmrc.</p>


                
                    <!-- Go to www.addthis.com/dashboard to customize your tools -->
                    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-574964d40b587768"></script>

                    <!-- Go to www.addthis.com/dashboard to customize your tools -->
                    <div class="addthis_sharing_toolbox"></div>
                

            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    
    <hr />
    <h3>Comentarios:</h3>
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>



                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                        <li>
                            <a href="https://twitter.com/DavidCehegin" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                        <li>
                            <a href="https://www.linkedin.com/in/davloperez" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap -->
<script src="/bootstrap/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'eatandcode';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


</body>

</html>